---
import { languages, getLangFromUrl, getLocalizedPath } from "../i18n/utils";
import { Icon } from "astro-icon/components";

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

// Remove language prefix from path if present
const pathWithoutLang = currentPath.replace(/^\/(en|de)/, "") || "/";

const sortedLanguages = languages.map((locale) => {
  return {
    code: locale,
    name:
      new Intl.DisplayNames([lang], { type: "language" }).of(locale) || locale,
  };
});
---

<div class="relative group">
  <button
    class="flex items-center gap-1 p-2 rounded-lg hover:bg-primary transition-colors text-primary-text"
    aria-label="Select language"
  >
    <Icon name="lucide:languages" class="w-5 h-5" aria-hidden="true" />
    <span class="text-sm font-medium uppercase">{lang}</span>
    <Icon name="lucide:chevron-down" class="w-4 h-4" aria-hidden="true" />
  </button>
  <div
    class="absolute top-full right-0 mt-2 w-32 bg-white text-primary rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200"
    role="menu"
  >
    {
      sortedLanguages.map((language, index, arr) => {
        const isFirst = index === 0;
        const isLast = index === arr.length - 1;
        const isActive = lang === language.code;

        const classes = [
          "block px-4 py-2 hover:bg-gray-100 hover:text-primary transition-colors",
          isFirst && "rounded-t-lg",
          isLast && "rounded-b-lg",
          isActive && "bg-cream font-bold",
        ]
          .filter(Boolean)
          .join(" ");

        return (
          <a
            href={getLocalizedPath(language.code as any, pathWithoutLang)}
            class={classes}
            role="menuitem"
            aria-current={isActive ? "page" : undefined}
          >
            {language.name}
          </a>
        );
      })
    }
  </div>
</div>
